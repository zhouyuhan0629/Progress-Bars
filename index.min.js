window.onload = function() {
    var r = new XMLHttpRequest();
    r.open("GET", "https://pb-api.herokuapp.com/bars", true);
    r.send(null);
    r.onreadystatechange = function() {
        if (r.readyState == 4 && r.status == 200) {
            var data = JSON.parse(r.responseText);
            var btns = data.buttons;
            var bars = data.bars;
            var limit = data.limit;
            setLimitValue(limit);
            setBars(bars);
            btns.sort((a, b) => a - b);
            setBtns(btns)
        }
    }
}

function setLimitValue(limit_value) {
    var tag_limit = document.getElementById('limit_value');
    tag_limit.innerHTML = limit_value
}

function setBars(bars) {
    for (i = 0; i < bars.length; i++) {
        var progress_div = document.createElement('div');
        progress_div.classList.add("progress")
        var bar_div = document.createElement('div');
        var bar_div_class = document.createAttribute("class");
        bar_div_class.value = "progress-bar progress-bar-striped active";
        bar_div.setAttributeNode(bar_div_class);
        var bar_div_role = document.createAttribute("role");
        bar_div_role.value = "progressbar";
        bar_div.setAttributeNode(bar_div_role);
        var bar_div_valuenow = document.createAttribute("aria-valuenow");
        bar_div_valuenow.value = bars[i];
        bar_div.setAttributeNode(bar_div_valuenow);
        var bar_div_valuemin = document.createAttribute("aria-valuemin");
        bar_div_valuemin.value = 0;
        bar_div.setAttributeNode(bar_div_valuemin);
        var bar_div_valuemax = document.createAttribute("aria-valuemax");
        var tag_limit = document.getElementById('limit_value');
        bar_div_valuemax.value = parseInt(tag_limit);
        bar_div.setAttributeNode(bar_div_valuemax);
        var bar_div_style = document.createAttribute("style");
        bar_div_style.value = "width:" + bars[i] + "%";
        bar_div.setAttributeNode(bar_div_style);
        bar_div.id = "bar" + i;
        bar_div.innerHTML = bars[i] + "%";
        var col_bars = document.querySelector(".col-bars");
        progress_div.appendChild(bar_div);
        col_bars.appendChild(progress_div);
        var progress_select = document.getElementById('col-select');
        progress_value = i + 1;
        progress_select.options.add(new Option("#progress" + progress_value, progress_value))
    }
}

function setBtns(btns) {
    for (i = 0; i < btns.length; i++) {
        var btn = document.createElement('button');
        var col_btns = document.querySelector(".col-btns");
        var btn_value = btns[i]
        btn.innerText = (btn_value > 0) ? "+" + btn_value : btn_value;
        btn.value = btn_value;
        var btn_onclick = document.createAttribute("onclick");
        btn_onclick.value = "calc(" + btn_value + ")";
        btn.setAttributeNode(btn_onclick);
        col_btns.appendChild(btn)
    }
}

function calc(btn_value) {
    var tag_limit = document.getElementById('limit_value');
    var limit = parseInt(tag_limit.innerText);
    var progress_select = document.getElementById('col-select');
    var index = progress_select.selectedIndex;
    var bar_div = document.getElementById("bar" + index);
    var bar_new_value = parseInt(bar_div.ariaValueNow) + btn_value;
    if (bar_new_value > limit) { bar_div.style.backgroundColor = "#dc3545" } else { bar_div.style.backgroundColor = "#007bff" }
    if (bar_new_value > 100) { bar_div.style.width = "100%" } else if (bar_new_value < 0) {
        bar_new_value = 0;
        bar_div.style.width = "0%"
    } else { bar_div.style.width = bar_new_value + "%" }
    bar_div.ariaValueNow = bar_new_value;
    bar_div.innerHTML = bar_new_value + "%"
}